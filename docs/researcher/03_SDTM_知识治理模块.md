# 研究者文档：03 - SDTM 知识治理模块

本文档面向对 Kosmos 核心算法感兴趣的研究人员和数据科学家，旨在深入解析其创新性的**流式领域主题模型 (Streaming Domain Topic Model, SDTM)** 的技术原理、工作流及其在知识库健康度优化中的应用。

## 1. 演进：从主题模型到健康度优化引擎

最初的 SDTM 旨在解决传统主题模型（如 LDA）在处理流式数据时的静态性和领域适应性不足的问题。然而，在 Kosmos 的演进中，SDTM 的概念得到了极大的扩展。

它不再仅仅是一个用于“发现”主题的模型，而是升华为一个主动的、由大语言模型（LLM）驱动的**知识库健康度诊断与优化引擎**。其核心任务从“建模”转变为“**通过迭代优化标签体系，提升知识库的组织质量和可检索性**”。

这个新范式的核心是**标签字典 (Tag Dictionary)**——一个结构化的、代表知识库领域知识本体的层级式标签集合。一个健康的知识库，其文档应该能被这套标签字典清晰、准确、无歧义地描述。

## 2. 核心原理：量化知识库的“健康度”

为了实现自动化优化，首先需要能够量化知识库的“不健康”状态。`app/models/sdtm.py` 中的 `QualityMetrics` 模型定义了关键的衡量指标：

-   **标注不足 (Under-annotated)**: 文档内容丰富，但应用的标签过少，无法充分概括其含有的知识点。
-   **标注过度 (Over-annotated)**: 文档应用的标签过多，可能包含了不相关或过于宽泛的标签，导致信息噪音。
-   **使用不足 (Under-used)**: 某些标签很少被使用，可能意味着它们定义得过于狭窄、与知识库内容脱节，或者是冗余的。
-   **使用过度 (Over-used)**: 某些标签被过于频繁地使用，可能意味着它们定义得太宽泛，需要被细化。
-   **无法区分 (Indistinguishable)**: 两个或多个文档被赋予了完全相同的标签集，但其内容实际上存在差异。这表明当前的标签字典粒度太粗，无���有效地区分这些文档，是知识库健康度最关键的负向指标。

系统通过 `/api/v1/sdtm/{kb_id}/stats` 和 `/api/v1/sdtm/{kb_id}/abnormal-documents` 这两个 API 端点，将这些量化指标和具体的“异常文档”暴露给用户，为启动优化流程提供决策依据。

## 3. 核心工作流：LLM 驱动的优化闭环

Kosmos 的 SDTM 通过一个精密的闭环工作流，利用 LLM 的推理能力来迭代式地优化标签字典和文档标注。该流程通过 `/api/v1/sdtm/{kb_id}/optimize` 接口启动。

```mermaid
graph TD
    A[1. 启动优化任务<br>(用户触发)] --> B{2. 智能采样};
    B --> C[3. 构建 LLM Prompt];
    C --> D[4. LLM 推理<br>(SDTM Engine)];
    D --> E{5. 解析引擎响应<br>(SDTMEngineResponse)};
    E --> F[6. 应用变更];
    F --> G[7. 持久化<br>(更新字典/标注)];
    G --> H{8. 循环或终止};
    H -- more iterations --> B;
    H -- completed --> I[9. 任务完成];

    subgraph "数据层"
        J[标签字典]
        K[文档/Chunks]
    end

    subgraph "外部智能"
        L[Large Language Model]
    end

    B -- 读取 --> K;
    C -- 包含 --> J;
    D -- 调用 --> L;
    F -- 写回 --> J;
    F -- 写回 --> K;

    style L fill:#d4edda
```

### 步骤详解：

1.  **启动与模式选择**: 用户通过 API 启动一个优化任务，并选择一种模式 (`SDTMMode`):
    *   **`SHADOW` (影子模式)**: LLM 只进行分析和提出建议，不执行任何修改。用于无风险地评估标签字典的质量和 LLM 的优化建议。
    *   **`EDIT` (编辑模式)**: LLM 的建议将**自动应用**于更新标签字典。
    *   **`ANNOTATE` (标注模式)**: LLM 将根据优化后的（或现有的）标签字典，为文档**自动生成或更新**标注。

2.  **智能采样**: 系统会从知识库中选择一个批次（`batch_size`）的文档进行处理。这个采样过程并非完全随机，而是会优先选择先前被识别为“异常”的文档（如无法区分、标注不足等），以确保每一轮迭代都聚焦在最需要优化的地方。

3.  **构建 LLM Prompt**: 这是整个流程的智慧核心。系统会动态构建一��复杂的 Prompt，将其发送给 LLM。这个 Prompt 通常包含：
    *   **角色指令**: "你是一位专业的知识工程师，你的任务是优化一个层级式标签字典..."
    *   **当前标签字典**: 将知识库现有的完整标签字典作为上下文提供给 LLM。
    *   **待处理文档**: 提供采样出的文档内容。
    *   **任务描述**: 指示 LLM 完成以下任务：
        a.  **批判性评估**: "评估当前的标签字典是否能有效、精确地描述这些文档。"
        b.  **提出字典修改建议**: "以JSON格式返回对字典的修改操作（`EditOperation`），操作类型包括新增、重命名、合并或删除标签。"
        c.  **提出文档标注建议**: "使用你优化后的新字典，为这些文档生成新的标签（`DocumentAnnotation`）。"
        d.  **提供推理过程**: "解释你做出这些修改和标注决策的详细理由（`reasoning`）。"

4.  **LLM 推理**: LLM 执行这个复杂的 Prompt，并返回一个结构化的响应。

5.  **解析引擎响应**: 后端服务将 LLM 返回的 JSON 解析为 `SDTMEngineResponse` Pydantic 模型，该模型清晰地包含了建议的 `operations`（字典编辑）、`annotations`（文档标注）和 `reasoning`（决策理由）。

6.  **应用变更**:
    *   在 **`SHADOW`** 模式下，此步骤被跳过。
    *   在 **`EDIT`** 模式下，`SDTMService` 会执行 `operations`，修改数据库中的标签字典。
    *   在 **`ANNOTATE`** 模式下，服务会更新文档的标签。

7.  **持久化与迭代**: 变更被保存到数据库。如果任务未达到最大迭代次数（`max_iterations`），则流程返回第 2 步，采样新的一批文档，开始下一轮优化。这个迭代过程使得标签字典能够基于整个知识库的内容分布，逐步演化至一个最优状态。

## 4. 技术价值与研究方向

这种将 LLM 集成到知识库管理闭环中的方法，开辟了多个前沿的技术与研究方向：

-   **知识本体的自动生成与演化**: SDTM 提供了一条从非结构化文本自动构建和动态维护领域知识本体（以标签字典为形式）的有效路径。
-   **人机协同的知识管理**: `SHADOW` 模式为人类专家提供高质量的机器建议，专家可以审核、��纳或拒绝这些建议，实现高效的人机协作。
-   **可解释的 AI 系统**: `reasoning` 字段的存在，使得整个优化过程不再是一个黑箱，极大地增强了系统的可信度和可解释性。
-   **自适应信息检索**: 经过 SDTM 优化的知识库，其标签体系更合理，文档区分度更高，这将直接提升下游语义搜索和推荐系统的准确性。

总之，Kosmos 的 SDTM 已经超越了传统主题模型的范畴，成为一个先进的、以提升知识库内在结构质量为目标的自动化知识工程系统。
