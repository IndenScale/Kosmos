# 备忘录：关于“端到端文档摄入”功能的设计

**日期**: 2025-09-10
**状态**: 已采纳

## 1. 背景与目标

为了提升 Kosmos 平台的易用性和自动化程度，我们探讨了实现一个统一的“端到端文档摄入”功能。其目标是用户上传一个文档后，系统能自动完成从内容提取、资产分析、分块到最终索引的全过程，而无需手动触发每个步骤。

## 2. 初始方案的挑战

一个理想的、具备强一致性保证的端到端工作流，需要对现有系统进行深度改造。在讨论中，我们识别出以下核心挑战：

1.  **复杂的异步编排**: 整个流程包含多个长耗时、异步的步骤，需要一个健壮的状态机和工作流引擎来管理任务之间的依赖关系。
2.  **高昂的重试成本**: 流程中的关键步骤（如 `MinerU` 内容提取、VLM 资产描述）是计算密集且成本高昂的，不能简单地进行自动重试。
3.  **级联失效**: 上游的变更（如更换嵌入模型、强制重处理文档）会导致所有下游产物（分块、索引）失效，需要复杂的依赖追踪和“缓存失效”管理机制。
4.  **僵尸任务**: 在分布式系统中，一个逻辑上已被中止的任务可能仍在运行。需要一种机制（如乐观锁或版本号）来阻止这些“僵尸任务”对数据库的脏写。

## 3. 约束与现实考量

考虑到当前项目的迭代阶段，对核心数据模型（如 `Documents`, `Jobs`）进行大规模修改（例如，添加 `version` 字段以实现乐观锁）的风险和成本过高。因此，我们决定寻求一种侵入性更小、更务实的解决方案。

## 4. 最终设计：“弱版本”的协调器方案

我们最终采纳了一种基于“**状态驱动的轮询触发**”模式的弱耦合方案。该方案的核心思想是，用一个外部的、定时的协调器层来保证流程的最终一致性，而不是依赖于各个任务之间紧密耦合的事件触发。

### 4.1. 核心组件

1.  **独立的触发器 Actors**:
    我们将在 `backend/app/tasks/triggers/` 目录下创建一系列新的、独立的、幂等的 `actor`：
    *   `trigger_asset_analysis_actor(document_id)`: 检查文档是否已完成内容处理，并为其所有待分析的资产创建分析任务。
    *   `trigger_chunking_actor(document_id)`: 检查文档是否已完成内容处理，并为其创建分块任务。
    *   `trigger_indexing_actor(document_id)`: 检查文档是否已完成分块，并为其创建索引任务。

2.  **Actor 的幂等性**:
    每个 `trigger_*` actor 的核心逻辑是在执行任何操作前，**必须先检查前置条件和当前状态**。例如，`trigger_asset_analysis_actor` 在启动任务前会检查：
    *   文档的 `canonical_content` 是否存在？
    *   资产是否已经有描述？
    *   是否已存在 `pending` 或 `running` 的同类分析任务？
    只有在所有条件都满足时，它才会创建新的任务。这确保了即使触发器被重复调用，也不会产生副作用。

3.  **双重调度机制**:
    *   **快速路径 (尽力而为)**: 在一个主流程（如 `document_processing`）成功结束后，它会**尝试**向消息队列发送一个下游的 `trigger_*` 消息（例如 `trigger_chunking_actor.send(...)`）。这是一个优化，旨在减少延迟。
    *   **可靠路径 (守护进程)**: 我们会创建一个定时的 `cron` 任务 (`scan_and_trigger_pipelines_actor`)，它会定期（例如每5分钟）扫描数据库，查找处于“中间状态”但流程中断的文档。如果发现一个文档已 `processed` 但分块任务从未启动，守护进程就会为它派发一个 `trigger_chunking_actor` 消息，从而“修复”中断的流程。

### 4.2. 优势

*   **低侵入性**: 无需修改现有的核心数据模型和复杂的业务 `actor`。
*   **高容错性 (自愈能力)**: 即使快速路径的触发失败，守护进程也能保证流程在下一个扫描周期被自动修复和推进，实现了最终一致性。
*   **简单与健壮**: 避免了复杂的分布式事务和依赖图管理，逻辑清晰，易于维护和扩展。

此方案在满足核心业务需求的同时，将实现复杂度和风险降至最低，符合当前阶段的项目目标。

---

## 附录A: “文档摄入”限界上下文的核心领域事件

以下事件构成了从单个文档到整个知识空间业务就绪的完整生命周期。它们是实现一个解耦、事件驱动架构的蓝图。

1.  **`DocumentUploadCompleted` (文档上传完成)**
    *   **触发时机**: 原始文件存储成功，`Original` 和 `Document` 数据库记录创建完毕。
    *   **意义**: 标志着摄入流程的正式起点，是触发 `DOCUMENT_PROCESSING` 任务的信号。

2.  **`EmbeddedDocumentsExtracted` (内嵌文档提取完成)**
    *   **触发时机**: 容器文档（如 `.docx`）分解完毕，所有内嵌文件已被识别并创建了各自的 `Document` 记录。
    *   **意义**: 明确了文档树的结构，为后续处理提供了完整的文档集合。

3.  **`DocumentContentExtracted` (文档内容提取完成)**
    *   **触发时机**: `MinerU` 成功将文档转化为结构化内容，`CanonicalContent` 和 `Asset` 记录创建完毕。
    *   **意义**: 流程中最核心的里程碑。标志着非结构化数据已转化为结构化知识，是内容分块 (`Chunking`) 和资产分析 (`Asset Analysis`) 两条并行流程的分叉点。

4.  **`DocumentChunkingCompleted` (文档分块完成)**
    *   **触发时机**: 文档的所有 `Chunks` 已成功生成并存储。
    *   **意义**: 标志着文本内容已准备好被索引。

5.  **`DocumentIndexingCompleted` (文档索引完成)**
    *   **触发时机**: 文档的所有 `Chunks` 已成功向量化并写入向量数据库。
    *   **意义**: 标志着文档的**文本部分**已变得完全可搜索。

6.  **`AllAssetsAnalyzed` (所有资产分析完成)**
    *   **触发时机**: 这是一个**聚合事件**，在一个文档关联的所有 `ASSET_ANALYSIS` 任务都完成后触发。
    *   **意义**: 标志着文档的**非文本部分**（图片、表格）的语义信息已提取完毕。

7.  **`DocumentIngestionCompleted` (文档摄入完成)**
    *   **触发时机**: 这是一个**最终聚合事件**，在 `DocumentIndexingCompleted` 和 `AllAssetsAnalyzed` 事件都发生后触发。
    *   **意义**: 标志着**单个文档**的端到端处理流程完全结束。

8.  **`KnowledgeSpaceAllDocumentsIngested` (知识空间所有文档摄入完成)**
    *   **触发时机**: 这是一个**业务里程碑事件**，在一个知识空间下的**所有**文档（包括子文档）都达到 `DocumentIngestionCompleted` 状态后触发。
    *   **意义**: 标志着整个知识空间的数据已**业务就绪**。它是从**知识库上下文**向下游的**评估服务上下文**发出“可以开始评估工作”的明确信号，是实现跨上下文业务流程自动化的关键。