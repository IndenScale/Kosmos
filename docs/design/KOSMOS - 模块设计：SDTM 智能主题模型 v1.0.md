# KOSMOS - 模块设计：SDTM 智能主题模型 v1.0

## 1. 概述

### 1.1 模块目标

流式领域主题模型（SDTM, Streaming Domain Topic Modeling）是Kosmos系统的**核心认知智能引擎**。其设计目标是解决传统知识库管理中两个长期存在的根本性挑战：

1.  **标签体系的静态性**: 知识是动态演进的，但知识库的标签体系往往是静态的，难以适应新知识的加入，导致分类逐渐失效。SDTM旨在让标签体系能够根据新摄入的文档内容**自我优化和持续演进**。
2.  **手动标注的高成本**: 为海量文档手动打标签不仅耗时巨大，而且难以保证标准统一和高质量。SDTM旨在利用大语言模型（LLM）的能力，实现对文档的**自动化、高一致性智能标注**。

通过SDTM，Kosmos从一个被动的知识存储系统，升级为一个能够主动理解、组织并优化其内部知识结构的"智慧体"。

### 1.2 核心创新：统一LLM调用架构

SDTM的实现核心是一种创新的**统一LLM调用架构**。该架构将"优化标签字典"和"为文档打标"这两个关联紧密但传统上分离的任务，合并到一次对LLM的调用中。

其工作流程如下：
1.  **构建丰富上下文**: SDTM服务从知识库中选取一批待处理文档（会优先选择"异常文档"，如标注不足或无法区分的文档），连同当前的标签字典、知识库健康度量指标等信息，共同构建一个全面的Prompt。
2.  **执行统一调用**: LLM接收此Prompt后，被指示执行一个两阶段的内部任务：
    *   **阶段一：编辑字典**。分析文档和现有标签，生成一系列**原子化编辑操作**（如增、删、改、合并标签）来优化标签字典。
    *   **阶段二：智能标注**。立即使用**刚刚在阶段一中优化过的新字典**，为当前这批文档生成最合适的标签。
3.  **返回结构化结果**: LLM返回一个包含"编辑操作列表"和"文档标注列表"的结构化JSON响应。

这种设计不仅极大地提升了处理效率，更重要的是确保了标签体系的优化与文档标注在逻辑上的**强一致性**。

## 2. 系统架构

SDTM作为一个核心模块，深度集成在Kosmos的后端服务中。

```mermaid
graph TD
    subgraph Kosmos Backend
        A[API Routers] --> B[SDTM Service];
        B --> C[SDTM Engine];
        C --> D[LLM];
        B --> E[Task Queue];
        B --> F[Database (SQLite)];
        B --> G[Vector DB (Milvus)];
        F -- Read/Write --> B;
        G -- Read/Write --> B;
    end

    A -- /api/v1/sdtm/** --> B;
    subgraph External Services
        D;
    end

    subgraph Infrastructure
        E;
        F;
        G;
    end

    style B fill:#cde4ff,stroke:#333,stroke-width:2px
    style C fill:#cde4ff,stroke:#333,stroke-width:2px
```

*   **SDTM Service (`sdtm_service.py`)**: **业务流程编排器**。负责对外提供API接口，管理SDTM任务的生命周期（通过`Task Queue`实现异步处理），控制迭代流程，并根据用户选择的模式决定如何将结果持久化到数据库。
*   **SDTM Engine (`sdtm_engine.py`)**: **核心计算引擎**。负责构建Prompt，与LLM进行交互，解析LLM返回的结果，并在内存中应用原子化的编辑操作。它将计算结果返回给`SDTM Service`，自身不直接操作数据库。

## 3. 核心流程与运行模式

SDTM的核心流程是`process_knowledge_base`，它以迭代的方式分批处理文档，直到满足终止条件（如达到最大迭代次数，或知识库"健康状况"良好）。在流程中，用户可以选择三种不同的运行模式，其核心区别在于**持久化策略**。

| 处理模式 | 标签字典操作 | 文档标注 | 持久化行为 | 核心应用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **编辑 (Edit)** | ✅ 分析并**应用** | ✅ 执行并**保存** | **完全持久化**：标签字典和文档标注都被更新 | 对知识库进行正式、全面的优化。 |
| **标注 (Annotation)** | ✅ 分析但**不应用** | ✅ 执行并**保存** | **仅持久化标注**：只有文档的标签被更新 | 在不改变现有标签体系的前提下，对新文档进行分类。 |
| **影子 (Shadow)** | ✅ 分析但**不应用** | ✅ 执行但**不保存** | **不持久化任何更改**：所有结果仅供预览 | 在不修改任何数据的情况下，评估和预览优化方案可能带来的影响。 |

## 4. 数据模型

为支持SDTM功能，新增及扩展了以下数据模型：

### 4.1 扩展模型

*   **`KnowledgeBase`**: 扩展了与SDTM相关的字段，如`sdtm_enabled`, `optimization_status`, `quality_metrics`等，用于跟踪和记录知识库的优化状态。

### 4.2 新增模型

*   **`SDTMJob`**: 记录每一次SDTM任务的详细信息，包括任务ID、知识库ID、运行模式、状态（pending, processing, completed, failed）、参数配置以及最终的JSON格式结果。

*   **`Chunk`**: 虽然是现有模型，但其`tags`字段是SDTM操作的核心目标之一，SDTM的标注结果最终会更新到该字段。

## 5. API 端点

SDTM模块通过以下API端点暴露其功能：

*   `POST /api/v1/sdtm/{kb_id}/jobs`: 启动一个异步的SDTM优化任务。请求体中可以指定运行模式 (`edit`, `annotate`, `shadow`) 及批处理大小、最大迭代次数等详细参数。
*   `GET /api/v1/sdtm/{job_id}`: 根据任务ID获取指定SDTM任务的当前状态、进度和最终结果。
*   `GET /api/v1/sdtm/{kb_id}/stats`: 获取指定知识库的SDTM相关统计数据，包括各类异常文档的数量和详情，用于前端仪表盘的展示。 