# 备忘录：Kosmos 下一代评估系统架构演进

**日期**: 2025年9月17日
**主题**: 明确 Kosmos KB、评估服务 (Assessment Service) 及评估代理调度系统的职责分工，指导系统迁移与重构工作。

## 1. 目标

为解决当前系统 (`relic_system`) 存在的紧耦合、职责不清等问题，我们将采用“绞杀榕”模式进行系统性重构。目标是将现有系统演进为一个由三个高内聚、低耦合的服务组成的现代化架构。本备忘录旨在清晰定义重构后各核心组件的**单一职责**和**交互边界**。

## 2. 核心组件职责定义

### 2.1. Kosmos 知识库 (Kosmos KB)

*   **核心职责**: **知识的统一存储、处理与检索中心 (The Single Source of Truth for Knowledge)**
*   **定位**: 一个独立的、强大的知识管理后端服务。
*   **具体任务**:
    *   **知识空间管理**: 提供创建、查询、更新、删除知识空间 (Knowledge Space) 的 API。
    *   **文档生命周期管理**:
        *   提供文档上传、下载、删除的 API。
        *   **自动化异步摄入**: 在文档上传后，自动触发内部的、事件驱动的文档处理流水线（格式转换、内容提取、分块、向量化、索引）。
    *   **知识检索**:
        *   提供强大的、多模态的知识检索 API (`/search`)，支持语义、关键词、标签等多种查询方式。
        *   提供精确的原文读取 (`/read`) 和模式匹配 (`/grep`) API。
*   **禁止事项**:
    *   **无评估概念**: Kosmos KB **不应**包含任何与“评估 (Assessment)”相关的业务逻辑、数据模型或概念（如 `Job`, `Framework`, `Finding`）。
    *   **无 Agent 逻辑**: 它不关心由谁、为何调用其 API，只负责高效、准确地响应知识服务的请求。

### 2.2. 评估服务 (Assessment Service)

*   **核心职责**: **评估业务逻辑的核心编排与状态管理中心 (The Brain of the Assessment Workflow)**
*   **定位**: 一个承载了评估领域所有核心业务逻辑的后端服务。
*   **具体任务**:
    *   **评估资产管理**:
        *   管理评估框架 (`AssessmentFramework`) 和控制项 (`ControlItemDefinition`) 的完整生命周期 (CRUD)。
    *   **作业与会话管理**:
        *   管理评估作业 (`AssessmentJob`) 的生命周期。在作业创建时，根据所选框架自动生成所有待处理的评估发现 (`AssessmentFinding`)。
        *   将大型 `Job` 分解为小型的、可执行的工作单元——评估会话 (`AssessmentSession`)。
    *   **状态跟踪**: 作为评估执行期间所有状态的**唯一事实来源**，精确跟踪每个 `Job`, `Session`, `Finding` 的实时状态。
    *   **Agent 调度**:
        *   提供 API 以触发 Agent 的执行。
        *   负责**启动 (spawn)** 一个或多个独立的 CLI Agent 进程，并将 `session_id` 作为参数传递给它们。
    *   **Agent 的后端服务**:
        *   为 CLI Agent 提供一套完整的 API，供其查询任务 (`GET /sessions/{id}`)、回写结果 (`PATCH /findings/{id}`) 和证据 (`POST /findings/{id}/evidence`)。

### 2.3. 评估代理调度系统 (原 `manage_system`)

*   **核心职责**: **面向用户的 API 网关与轻量级调度器 (User-Facing API Gateway & Lightweight Scheduler)**
*   **定位**: 系统的主要用户入口，负责将用户意图转换为对后端服务的调用。
*   **具体任务**:
    *   **用户认证与管理**: 继续负责人机交互场景下的用户注册、登录和权限管理。
    *   **API 请求透传**:
        *   将所有与评估框架、评估作业相关的**业务逻辑请求**（如创建、查询）直接**透传 (proxy)** 到 **评估服务 (Assessment Service)**。
        *   自身**不再保留** `Job`, `Framework`, `Task` 等核心业务数据模型和处理逻辑。
    *   **触发 Agent 执行**:
        *   在接收到用户“启动评估”的指令后，调用**评估服务**的 API 来创建 `Job` 和 `Session`。
        *   获取到 `session_id` 后，调用**评估服务**提供的调度接口来启动 CLI Agent。
    *   **凭证管理**: 继续管理连接到 **Kosmos KB** 和 OpenAI 兼容模型的凭证，但在数据结构上需与新系统对齐（如 `knowledge_space_id`）。

## 3. 交互流程（总结）

1.  **用户**通过**调度系统**的 UI/API 发起操作（例如，创建框架，启动评估）。
2.  **调度系统**将这些业务请求**透传**给**评估服务**。
3.  **评估服务**处理业务逻辑，创建 `Job` 和 `Session`，并启动 **CLI Agent**。
4.  **CLI Agent** 启动后，通过 **评估服务** 的 API 查询任务，然后直接调用 **Kosmos KB** 的 API 来检索证据。
5.  **CLI Agent** 将评估结果通过 API 写回**评估服务**。
6.  **调度系统**通过轮询**评估服务**的 API 来向用户展示评估的实时进度。

## 4. 下一步行动

基于以上职责划分，立即启动以下工作：
1.  **API 设计**: 详细定义 `评估服务` 所需的全部 API 端点。
2.  **数据库迁移**: 规划并执行将 `调度系统` 的核心业务数据（Frameworks, Controls）迁移至 `评估服务` 数据库的方案。
3.  **代码重构**: 并行开展 `调度系统` 的 API 透传改造和 `评估服务` 的功能增强开发。

---
