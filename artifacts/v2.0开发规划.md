# Kosmos v2.0 开发规划

## 1. 概述

本规划旨在指导 Kosmos 知识库系统从 v1.0 架构向 v2.0 架构的渐进式重构与开发。v2.0 核心目标是引入 **Fragment 层** 作为文档内容的“能指”抽象层，以取代原先分散的 `Chunk`、`PageScreenshot` 和未显式建模的 `Figure` 概念，从而提升系统的清晰度、可扩展性和智能处理能力。

## 2. 核心设计理念 (来自 v2.0 设计文档)

1.  **内容与语境分离**: 通过区分**物理文档 (Physical Document)** 和 **逻辑文档 (Logical Document)**，实现原始文件存储与知识库应用的解耦。
2.  **所指与能指分离**: 将知识单元划分为 **片段 (Fragment)**（所指，内容原子）和 **索引 (Index)**（能指，语义表达），实现灵活的索引技术和精准定位。

## 3. v2.0 核心架构组件

### 3.1. 数据模型层 (Model Layer)

#### 3.1.1. 新增/重构模型

*   **`app.models.fragment.Fragment` (基类)**
    *   **描述**: 文档片段基类，代表文档内容的稳定物理单元。
    *   **核心字段**:
        *   `id` (UUID): Fragment 的唯一标识符。
        *   `content_hash` (FK): 关联到 `PhysicalDocument`，确保 Fragment 与物理内容的稳固绑定。
        *   `document_id` (FK): 辅助字段，关联到逻辑 `Document` 记录。
        *   `fragment_index`: 片段在文档中的顺序索引。
        *   `fragment_type`: 片段类型 ('text', 'screenshot', 'figure')。
        *   `raw_content`: 存储原始内容（文本、文件路径/URI）。
        *   `meta_info` (JSON): 存储与片段类型相关的元数据。
        *   `created_at`: 创建时间。
*   **`app.models.fragment.KBFragment` (关联表)**
    *   **描述**: 知识库与文档片段的关联表，明确 Fragment 的逻辑归属。
    *   **核心字段**:
        *   `kb_id` (FK)
        *   `fragment_id` (FK)
        *   `added_at`: 添加到知识库的时间。
*   **`app.models.index.Index`**
    *   **描述**: 索引条目模型，代表 Fragment 在向量数据库（如 Milvus）中的可检索表达。
    *   **核心字段**:
        *   `id` (与 `Fragment.id` 对应)
        *   `kb_id` (FK)
        *   `fragment_id` (FK)
        *   `tags` (JSON): LLM 生成的标签。
        *   `content` (冗余): 内容预览/摘要，用于减少查询次数。
        *   `embedding`: (主要存储于 Milvus) 向量嵌入。
        *   `created_at`, `updated_at`
*   **`app.models.job.Job` & `app.models.task.Task`**
    *   **描述**: 调度系统实体，用于管理长耗时的后台操作（如文档摄入、索引更新）。
    *   **核心字段**:
        *   `Job`: `job_id` (UUID), `kb_id`, `type`, `status`, `payload`, `created_at`, `finished_at`
        *   `Task`: `task_id` (UUID), `job_id` (FK), `type`, `status`, `payload`, `result`, `dependency_task_id`, `created_at`, `started_at`, `finished_at`

#### 3.1.2. 演进中的现有模型

*   `PhysicalDocument`, `Document`, `KBDocument`, `User`, `KnowledgeBase` 需要适应新的架构，特别是 `KnowledgeBase` 的配置管理。
*   `Chunk`, `PageScreenshot` 模型将在新流程稳定后逐步清理或归档。

### 3.2. 服务层 (Service Layer)

#### 3.2.1. 核心服务重构

*   **`app.services.ingestion_service.IngestionService`**
    *   **职责变更**: 从直接处理 `Chunk` 转向生成 `Fragment` 和 `Index` 条目。
    *   **流程**:
        1.  调用合适的 `Processor` 生成结构化内容块。
        2.  根据内容块创建不同类型的 `Fragment` (Text/Screenshot/Figure)。
        3.  为需要索引的 `Fragment` 创建 `Index` 条目。
        4.  将 `Fragment` 和 `KBFragment` 信息存入 SQL。
        5.  将 `Index` 数据（`embedding`, `tags`, `content`）存入 Milvus。
*   **`app.services.search_service.SearchService`**
    *   **职责变更**: 主要与 `Index` 层交互进行语义搜索。
    *   **流程**:
        1.  将用户查询进行 embedding。
        2.  在 Milvus 中进行向量相似度搜索和标签过滤。
        3.  根据召回的 `Index` 条目中的 `fragment_id`，从 SQL 查询 `Fragment` 信息。
        4.  组装并返回最终结果。
*   **`app.services.sdtm_service.SDTMService`**
    *   **职责**: 智能标签生成和标签字典优化，更新 `Index` 中的 `tags` 字段，并同步到 SQL 和 Milvus。
*   **`app.services.kb_service.KBService`**
    *   **职责**: 管理 `KnowledgeBase`，包括其配置（标签字典、嵌入配置、搜索配置）。
*   **`app.services.document_service.DocumentService`**
    *   **职责**: 管理 `Document` 和 `KBDocument` 的 CRUD，处理文件上传和物理存储。
*   **新增服务 (可选)**:
    *   `FragmentService`: 专门负责 `Fragment` 及其关联 (`KBFragment`) 的管理。

### 3.3. 处理层 (Processing Layer)

*   **`app.processors.*`**: 处理器需要更新以生成 `Fragment`。
    *   **`PDFProcessor`**: 生成 `ScreenshotFragment` 和 `FigureFragment` (带 VLM 描述)，然后处理文本生成 `TextFragment`。
    *   **`GenericProcessor`**: 生成 `TextFragment`。
    *   **`ImageProcessor`**: 生成 `FigureFragment`。
*   **`app.utils.intelligent_text_splitter.IntelligentTextSplitter`**: 可能需要调整以处理 Fragment 的生成逻辑，或其功能被整合到处理器中。

### 3.4. 数据访问层 (Repository Layer)

*   **`app.repositories.*`**: 需要新增或重构 Repository 来支持新的 Fragment 和 Index 模型。
    *   `FragmentRepository`
    *   `IndexRepository`
    *   `JobRepository`, `TaskRepository`

### 3.5. 调度系统 (Job/Task Scheduler)

*   **实现**: 基于 `Job` 和 `Task` 模型，使用消息队列（如 Redis/RabbitMQ）和后台 Worker 进程。
*   **核心 Job**:
    *   `DOC_INGESTION`: 管理文档从上传到生成 Fragment 和 Index 的全过程。
    *   `KB_REINDEX`: 当 KnowledgeBase 配置更新时，管理相关 Fragment 的 Index 更新。
*   **Worker**: 独立的后台服务，监听队列，执行 Task。

## 4. 渐进式重构策略

v2.0 开发将遵循渐进式重构原则，确保现有功能不受干扰。

### 4.1. Phase 1: 基础模型与调度系统搭建

*   **目标**: 完成 Fragment/Index/Job/Task 模型的定义和数据库迁移。
*   **任务**:
    1.  在 `app/models/` 下创建 `fragment.py`, `index.py`, `job.py`, `task.py`。
    2.  编写数据库迁移脚本 (`db/scripts/`) 以创建新的表结构。
    3.  开发基础的 Repository 层 (`app/repositories/`) 支持新模型的 CRUD。
    4.  实现基本的 Job/Task 调度框架 (包括 Worker)。

### 4.2. Phase 2: Fragment 层核心逻辑实现

*   **目标**: 实现 Fragment 的生成、存储和基本关联。
*   **任务**:
    1.  更新 `PDFProcessor` 以生成 `ScreenshotFragment` 和 `FigureFragment`。
    2.  更新 `GenericProcessor`、`ImageProcessor` 等以生成对应的 Fragment。
    3.  更新 `IngestionService` 核心逻辑，使其创建和管理 Fragment 和 KBFragment。
    4.  开发/完善 `FragmentService` (如果需要)。

### 4.3. Phase 3: Index 层与搜索集成

*   **目标**: 实现 Index 的生成、存储和基于 Index 的搜索。
*   **任务**:
    1.  更新 `IngestionService`，使其为 Fragment 创建 Index 条目并存入 Milvus。
    2.  更新 `SearchService`，使其基于 Milvus 中的 Index 进行搜索。
    3.  确保搜索结果能正确关联回 Fragment 和原始 Document。

### 4.4. Phase 4: SDTM 与配置管理升级

*   **目标**: 将 SDTM 和知识库配置管理升级到 v2.0 架构。
*   **任务**:
    1.  更新 `SDTMService`，使其操作基于 Fragment 和 Index。
    2.  更新 `KBService` 以支持新的 JSONB 配置字段和版本管理。
    3.  实现 `KB_REINDEX` Job，当配置更新时自动触发相关 Index 的更新。
    4.  更新前端以支持新的配置管理界面。

### 4.5. Phase 5: 功能迁移与旧模型清理

*   **目标**: 将所有功能完全迁移到新架构，并清理旧模型。
*   **任务**:
    1.  全面测试新架构下的所有功能（摄入、搜索、SDTM、API）。
    2.  逐步将前端调用从旧 API 迁移到新 API。
    3.  在确保新架构稳定运行后，制定并执行旧 `Chunk`/`PageScreenshot` 模型及相关代码的清理计划。

## 5. 关键技术点与挑战

*   **数据一致性**: 确保 SQL (Fragment/KBF/KBase) 和 Milvus (Index) 之间的数据一致性，尤其是在更新和删除操作时。
*   **调度系统可靠性**: 实现健壮的 Job/Task 管理，包括状态跟踪、错误处理、依赖管理和 Worker 容错。
*   **性能优化**: 对于大规模 Fragment 和 Index，需要优化数据库查询和 Milvus 搜索性能。
*   **平滑过渡**: 确保重构过程不影响现有用户的正常使用，提供清晰的迁移路径。

## 6. 预期收益

*   **架构清晰**: Fragment/Index 分离使系统结构更清晰，易于理解和维护。
*   **扩展性强**: 新增 Fragment 类型和索引技术更容易。
*   **智能性提升**: Fragment 层为更复杂的 AI 处理（如 VLM 对图片的理解）提供了更好的基础。
*   **性能与可靠性**: 异步调度系统和明确的职责分离有助于提升系统整体性能和健壮性。